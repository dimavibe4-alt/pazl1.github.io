<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>ПАЗЛ — Блок учета</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}
        body{background-color:#f8f9fa;color:#333;line-height:1.5;overflow-x:hidden}
        .header{background:linear-gradient(135deg,#1a2b47,#2c3e50);color:#fff;padding:1.2rem 2rem;box-shadow:0 2px 10px rgba(0,0,0,.15);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem}
        .header-title{display:flex;align-items:center;gap:15px}
        .logo-title-container{display:flex;align-items:center;gap:15px}
        .logo{height:100px;width:auto;cursor:pointer;transition:all .5s ease;border-radius:8px;filter:brightness(1) drop-shadow(0 2px 4px rgba(0,0,0,.3));animation:logoEntrance 1s ease-out}
        .logo:hover{transform:scale(1.1) rotate(5deg);filter:brightness(1.2) drop-shadow(0 5px 15px rgba(0,0,0,.4));animation:pulse 1.5s infinite}
        .logo:active{transform:scale(.95) rotate(-5deg);transition:all .1s ease}
        @keyframes pulse{0%{transform:scale(1.1) rotate(5deg)}50%{transform:scale(1.15) rotate(5deg)}100%{transform:scale(1.1) rotate(5deg)}}
        @keyframes logoEntrance{0%{opacity:0;transform:scale(.5) rotate(-180deg)}70%{transform:scale(1.1) rotate(10deg)}100%{opacity:1;transform:scale(1) rotate(0)}}
        .title-text{display:flex;flex-direction:column}
        .header-title h1{font-size:1.8rem;margin-bottom:.3rem}
        .header-title p{font-size:1rem;opacity:.9}
        .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
        select,button{padding:.5rem 1rem;border:1px solid #ccc;border-radius:4px;background:#fff;font-size:.95rem;cursor:pointer;transition:all .2s ease}
        select:hover,button:hover{border-color:#1a2b47;box-shadow:0 2px 6px rgba(0,0,0,.1)}
        button.export{background:#28a745;color:#fff;border-color:#218838}
        button.print{background:#17a2b8;color:#fff;border-color:#138496}
        button.settings{background:#6c757d;color:#fff;border-color:#545b62}
        .container{max-width:1600px;margin:1.5rem auto;padding:0 1.5rem}
        .menu-button{background:#1a2b47;color:#fff;border:none;padding:.6rem 1.2rem;border-radius:4px;cursor:pointer;font-weight:bold;display:flex;align-items:center;gap:.5rem;transition:all .3s ease;margin-bottom:1rem}
        .menu-button:hover{background:#2c4061;transform:translateY(-1px)}
        .menu-dropdown{display:none;position:absolute;background:#fff;min-width:220px;box-shadow:0 8px 16px rgba(0,0,0,.15);border-radius:6px;z-index:1000;margin-top:.5rem;border:1px solid #ddd}
        .menu-dropdown.show{display:block}
        .menu-item{padding:.75rem 1.2rem;cursor:pointer;transition:background-color .2s;display:flex;align-items:center;gap:.7rem;font-size:.95rem}
        .menu-item:hover{background:#f8f9fa}
        .menu-item.active{background:#e3f2fd;color:#1a2b47;font-weight:bold}

        .damage-green{background:#d4edda!important;color:#155724;font-weight:bold}
        .damage-yellow{background:#fff3cd!important;color:#856404;font-weight:bold}
        .damage-orange{background:#ffe0b2!important;color:#e65100;font-weight:bold}
        .damage-gray{background:#e9ecef!important;color:#495057;font-weight:bold}
        .warning-indicator{color:#dc3545;font-weight:bold;font-size:1.1rem;animation:blink 2s infinite}
        @keyframes blink{0%,50%{opacity:1}51%,100%{opacity:.3}}

        .accounting-container{display:flex;flex-wrap:wrap;gap:1rem;margin-bottom:1rem}
        .trucks-section{flex:0 0 40%;display:flex;flex-direction:column;gap:1rem;min-width:0}
        .warehouse-section{flex:1;display:flex;flex-direction:column;gap:1rem;min-width:0}

        .card{background:#fff;border-radius:8px;padding:1rem;box-shadow:0 2px 8px rgba(0,0,0,.08);min-height:150px}
        .card-title{font-size:1rem;font-weight:600;margin-bottom:.3rem;color:#1a2b47;border-bottom:1px solid #eee;padding-bottom:.1rem}

        .trucks-list-container{max-height:507px;overflow-y:auto;overflow-x:auto;border:1px solid #e0e0e0;border-radius:8px;background:#fff}
        .trucks-list-container.expanded{overflow:hidden}
        .trucks-list-container.expanded .truck-row:not(.active){display:none}
        .trucks-list-container.expanded .tires-details-container:not(.expanded){display:none}
        .truck-table{width:100%;border-collapse:collapse;min-width:500px;font-size:.85rem}
        .truck-table th,.truck-table td{padding:.5rem;text-align:left;border-bottom:1px solid #e0e0e0}
        .truck-table th{background:#f8f9fa;font-weight:600;color:#495057;position:sticky;top:0;font-size:.85rem}
        .truck-row{cursor:pointer;transition:background-color .2s}
        .truck-row:hover{background:#f8f9fa}
        .truck-row.active{background:#e3f2fd;position:sticky;top:42px;z-index:10;box-shadow:0 2px 4px rgba(0,0,0,.1)}

        .tires-details-container{display:none;background:#f8f9fa;padding:0}
        .tires-details-container.expanded{display:table-row}
        .tire-details-cell{padding:0!important;border-bottom:1px solid #e0e0e0}
        .tire-details-table-container{overflow-x:auto}
        .tire-details-table{width:100%;border-collapse:collapse;font-size:.7rem}
        .tire-details-table th,.tire-details-table td{padding:.2rem .4rem;text-align:left;border-bottom:1px solid #e0e0e0;vertical-align:top}
        .tire-details-table th{background:#e9ecef;font-weight:600;color:#495057;position:sticky;top:0}
        .tire-details-table tr.tire-block{border-bottom:2px solid #1a2b47!important}
        .empty-tire{color:#6c757d;font-style:italic}

        .tire-block-container{border-bottom:2px solid #1a2b47;}
        .tire-block-container.dragging{opacity:.5;background:#d1ecf1!important;}
        .tire-draggable{cursor:grab;transition:all .2s ease}
        .tire-draggable:hover{background:#e3f2fd!important}

        .drop-zone{transition:all .3s ease;min-height:20px}
        .drop-zone.drag-over{background:#d4edda!important;box-shadow:inset 0 0 10px rgba(40,167,69,.3)}
        .position-drop-zone{position:relative}
        .position-drop-zone::after{content:"";position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(40,167,69,.1);border:2px dashed #28a745;pointer-events:none;opacity:0;transition:opacity .3s ease}
        .position-drop-zone.drag-over::after{opacity:1}

        /* Новая подсветка КОНТЕЙНЕРА занятых позиций при дропе */
        .tire-details-table-container.drag-over{
            outline:2px dashed #28a745;
            background:rgba(40,167,69,.08);
        }

        .warehouse-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;flex-wrap:wrap;gap:10px}
        .warehouse-controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
        .search-container{position:relative;flex:1;max-width:300px}
        .search-input{width:100%;padding:8px 12px;border:1px solid #ccc;border-radius:4px;font-size:.9rem}
        .search-results{position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-top:none;border-radius:0 0 4px 4px;max-height:200px;overflow-y:auto;z-index:1000;display:none;box-shadow:0 2px 5px rgba(0,0,0,.1)}
        .search-result-item{padding:8px 12px;cursor:pointer;border-bottom:1px solid #f0f0f0}
        .search-result-item:hover{background:#f8f9fa}

        .warehouse-tabs{display:flex;overflow-x:auto;gap:8px;padding:10px 0;border-bottom:1px solid #e0e0e0;margin-bottom:10px}
        .warehouse-tab{padding:8px 16px;background:#f8f9fa;border:1px solid #dee2e6;border-radius:20px;cursor:pointer;white-space:nowrap;flex-shrink:0;transition:all .2s ease;font-size:.9rem}
        .warehouse-tab:hover{background:#e9ecef}
        .warehouse-tab.active{background:#1a2b47;color:#fff;border-color:#1a2b47}

        .warehouse-table-container{max-height:420px;overflow-y:auto;overflow-x:auto;border:1px solid #e0e0e0;border-radius:8px;background:#fff}
        .warehouse-table{width:100%;border-collapse:collapse;min-width:800px;font-size:.7rem}
        .warehouse-table th,.warehouse-table td{padding:.2rem .4rem;text-align:left;border-bottom:1px solid #e0e0e0;vertical-align:top}
        .warehouse-table th{background:#e9ecef;font-weight:600;color:#495057;position:sticky;top:0;cursor:pointer;user-select:none}
        .warehouse-table th.sortable:hover{background:#dde1e5}
        .warehouse-table th.sortable::after{content:"⏷";opacity:.5;margin-left:5px;font-size:.7rem}
        .warehouse-table th.sortable.asc::after{content:"▲";opacity:.8}
        .warehouse-table th.sortable.desc::after{content:"▼";opacity:.8}
        .warehouse-table tr.tire-block{border-bottom:2px solid #1a2b47!important}

        .repair-tooltip{position:relative;display:inline-block;cursor:pointer}
        .repair-tooltip .tooltip-text{visibility:hidden;min-width:200px;max-width:420px;background:#555;color:#fff;text-align:left;border-radius:6px;padding:8px;position:absolute;z-index:1000;top:100%;left:0;margin-top:5px;opacity:0;transition:opacity .3s;font-size:.7rem;box-shadow:0 2px 10px rgba(0,0,0,.2);white-space:normal}
        .repair-tooltip .tooltip-text::after{content:"";position:absolute;bottom:100%;left:15px;margin-left:-5px;border-width:5px;border-style:solid;border-color:transparent transparent #555 transparent}
        .repair-tooltip:hover .tooltip-text{visibility:visible;opacity:1}
        .warehouse-table .repair-tooltip .tooltip-text{top:100%;right:0;left:auto;margin-top:5px;max-width:min(420px,calc(100vw - 32px))}
        .warehouse-table .repair-tooltip .tooltip-text::after{left:auto;right:15px;border-color:transparent transparent #555 transparent}

        .stats-section{display:flex;overflow-x:auto;gap:.5rem;padding:.5rem;background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.08);height:150px}
        .stat-card{flex:0 0 auto;width:108px;padding:.5rem;background:#f8f9fa;border-radius:6px;text-align:center}
        .stat-card h4{margin-bottom:.3rem;color:#1a2b47;font-size:.8rem}
        .stat-value{font-size:1rem;font-weight:bold;color:#1a2b47;margin-bottom:.3рем}
        .stat-warning{color:#dc3545;font-size:.7rem}

        .action-row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
        .btn{padding:.5rem 1rem;border:1px solid;border-radius:4px;cursor:pointer;font-size:.9rem;transition:all .2s ease}
        .btn-primary{background:#1a2b47;color:#fff;border-color:#1a2b47}
        .btn-primary:hover{background:#2c4061;border-color:#2c4061}
        .btn-secondary{background:#6c757d;color:#fff;border-color:#6c757d}
        .btn-secondary:hover{background:#5a6268;border-color:#545b62}
        .btn-filter{background:#6f42c1;color:#fff;border-color:#6f42c1}
        .btn-filter:hover{background:#5a36a3;border-color:#5a36a3}

        .empty-section{display:flex;align-items:center;justify-content:center;height:100%;color:#6c757d;font-style:italic}

        .modal-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:10000}
        .modal-overlay.active{display:flex}
        .modal{background:#fff;border-radius:8px;padding:20px;min-width:420px;max-width:90%;box-shadow:0 2px 10px rgba(0,0,0,0.1);transition:all .3s ease}
        .modal.wide{min-width:600px}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .modal-close{background:none;border:none;font-size:1.5rem;cursor:pointer}
        .modal-body{margin-bottom:15px}
        .modal-footer{display:flex;justify-content:flex-end;gap:10px}
        .form-group{margin-bottom:10px}
        .form-group label{display:block;margin-bottom:5px;font-weight:500}
        .form-control{width:100%;padding:8px;border:1px solid #ccc;border-radius:4px}
        .warning-message{background:#fff3cd;border:1px solid #ffeaa7;border-radius:4px;padding:10px;margin-bottom:15px;color:#856404}
        .replacement-section{border-top:1px solid #eee;padding-top:15px;margin-top:15px;display:none}
        .replacement-section.active{display:block}

        .repair-yes{color:#8B0000!important;font-weight:bold!important;text-transform:uppercase}

        .summary-container{max-height:70px;overflow-y:auto;overflow-x:auto;border:1px solid #e0e0e0;border-radius:8px;background:#fff}
        .summary-table{width:100%;border-collapse:collapse;font-size:.7rem}
        .summary-table th,.summary-table td{padding:.2rem .4rem;text-align:center;border:1px solid #e0e0e0}
        .summary-table th{background:#e9ecef;font-weight:600;color:#495057;position:sticky;top:0}
        .summary-table tr:nth-child(even){background:#f8f9fa}

        .truck-table th.sortable{cursor:pointer;user-select:none;position:relative}
        .truck-table th.sortable:hover{background:#e9ecef}
        .truck-table th.sortable::after{content:"⏷";opacity:.5;margin-left:5px;font-size:.8rem}
        .truck-table th.sortable.asc::after{content:"▲";opacity:.8}
        .truck-table th.sortable.desc::after{content:"▼";opacity:.8}

        @media (max-width:1200px){.accounting-container{flex-direction:column}.trucks-section,.warehouse-section{flex:1}}
        @media (max-width:768px){
            .header{padding:.8rem 1rem}
            .header-title h1{font-size:1.3rem}
            .header-title p{font-size:.8rem}
            .controls{width:100%;justify-content:flex-start}
            .header-title{flex-direction:column;align-items:flex-start}
            .logo-title-container{margin-bottom:5px}
            .container{padding:0 .8rem}
            .tire-details-table{font-size:.7rem}
            .tire-details-table th,.tire-details-table td{padding:.3rem}
            .stat-card{width:150px}
            .card{padding:.8rem}
            .warehouse-header{flex-direction:column;align-items:flex-start}
            .warehouse-controls{width:100%;justify-content:space-between}
            .search-container{max-width:100%}
            .modal{min-width:90%;padding:15px}
            .modal.wide{min-width:90%}
        }
        @media (max-width:480px){
            .header{flex-direction:column;align-items:flex-start}
            .controls{justify-content:space-between}
            select,button{padding:.4rem .6rem;font-size:.8rem}
            .trucks-list-container{max-height:400px}
            .truck-table th,.truck-table td{padding:.4rem;font-size:.85rem}
            .stats-section{gap:.5rem;padding:.5rem}
            .stat-card{width:130px;padding:.6rem}
            .stat-card h4{font-size:.8rem}
            .stat-value{font-size:1.1rem}
        }

        .tire-num{border-bottom:1px dashed #1a2b47}
        .highlighted{background:#fff3cd!important;animation:highlight 2s ease}
        @keyframes highlight{0%{background:#fff3cd}100%{background:inherit}}

        /* Чередование строк */
        .tire-details-table tr:nth-child(even){background:#f8f9fa}
        .tire-details-table tr:nth-child(odd){background:#fff}
        .warehouse-table tr:nth-child(even){background:#f8f9fa}
        .warehouse-table tr:nth-child(odd){background:#fff}
    </style>
</head>
<body>

    <div class="header">
        <div class="header-title">
            <div class="logo-title-container">
                <img src="пазл.png" alt="Логотип ПАЗЛ" class="logo" onclick="window.location.href='slide2.html'">
                <div class="title-text">
                    <h1>ПАЗЛ</h1>
                    <p>Программный Аналитический модуль Зондирования и Логистического управления СКГШ</p>
                    <p>УК УГОЛЬНЫЙ РАЗРЕЗ</p>
                </div>
            </div>
        </div>
        <div class="controls">
            <select id="regionSelect">
                <option>Регион: Все</option><option>Регион 1</option><option>Регион 2</option>
            </select>
            <select id="enterpriseSelect">
                <option>Предприятие: Все</option><option>Разрез 1</option><option>Разрез 2</option><option>Разрез 3</option>
            </select>
            <button class="export">Экспорт</button>
            <button class="print">Печать</button>
            <button class="settings">Настройки</button>
        </div>
    </div>

    <div class="container">
        <button class="menu-button" id="menuButton">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
            </svg>
            Меню системы
        </button>

        <div class="menu-dropdown" id="menuDropdown">
            <div class="menu-item" onclick="window.location.href='slide3.html'">Главный экран</div>
            <div class="menu-item active" onclick="window.location.href='accounting.html'">Блок учета</div>
            <div class="menu-item" onclick="navigateTo('monitoring')">Мониторинг</div>
            <div class="menu-item" onclick="navigateTo('engineer')">Блок шинного инженера</div>
            <div class="menu-item" onclick="navigateTo('analytics')">Аналитика</div>
            <div class="menu-item" onclick="navigateTo('forecast')">Прогноз потребности</div>
            <div class="menu-item" onclick="navigateTo('constructor')">Конструктор отчетов</div>
            <div class="menu-item" onclick="navigateTo('quality')">Качество дорог</div>
            <div class="menu-item" onclick="navigateTo('documents')">Документы и литература</div>
        </div>

        <div class="accounting-container">
            <!-- ЛЕВАЯ КОЛОНКА -->
            <div class="trucks-section">
                <div class="card">
                    <h3 class="card-title">Перечень самосвалов</h3>
                    <div class="trucks-list-container" id="trucksListContainer">
                        <table class="truck-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-key="id">№ А/С</th>
                                    <th class="sortable" data-key="model">Модель</th>
                                    <th class="sortable" data-key="wheelbase">Колесная база</th>
                                    <th class="sortable" data-key="tiresCount">Кол-во шин (план/факт)</th>
                                    <th class="sortable" data-key="status">Статус</th>
                                </tr>
                            </thead>
                            <tbody id="trucks-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <div class="stats-section">
                    <div class="stat-card"><h4>Всего самосвалов</h4><div class="stat-value">30</div></div>
                    <div class="stat-card"><h4>БелАЗ 75131</h4><div class="stat-value">8</div><div class="stat-warning">Требует внимания: 3</div></div>
                    <div class="stat-card"><h4>БелАЗ 7513D</h4><div class="stat-value">6</div><div class="stat-warning">Требует внимания: 4</div></div>
                    <div class="stat-card"><h4>БелАЗ 75306</h4><div class="stat-value">7</div><div class="stat-warning">Требует внимания: 5</div></div>
                    <div class="stat-card"><h4>БелАЗ 7530G</h4><div class="stat-value">9</div><div class="stat-warning">Требует внимания: 2</div></div>
                </div>
            </div>

            <!-- ПРАВАЯ КОЛОНКА -->
            <div class="warehouse-section">
                <div class="card">
                    <div class="warehouse-header">
                        <h3 class="card-title">Склад</h3>
                        <div class="warehouse-controls">
                            <div class="search-container">
                                <input type="text" class="search-input" id="tireSearch" placeholder="Поиск по номеру шины...">
                                <div class="search-results" id="searchResults"></div>
                            </div>
                            <button class="btn btn-primary" id="btnRecs">Рекомендации</button>
                            <button class="btn btn-secondary" id="btnAdd">Добавить</button>
                            <button class="btn btn-filter" id="btnFilter">Фильтр</button>
                        </div>
                    </div>
                    <div class="warehouse-tabs" id="warehouseTabs"></div>
                    <div class="warehouse-table-container" id="warehouseTableContainer">
                        <table class="warehouse-table" id="warehouseTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-key="substock">Подсклад</th>
                                    <th class="sortable" data-key="row">Ряд</th>
                                    <th class="sortable" data-key="place">Место</th>
                                    <th class="sortable" data-key="number">№ шины</th>
                                    <th class="sortable" data-key="brand">Бренд / Модель / Рисунок</th>
                                    <th class="sortable" data-key="size">Размер / Пробег / Состояние</th>
                                    <th class="sortable" data-key="ogp">ОГП план / факт / % износа</th>
                                    <th class="sortable" data-key="repair">Ремонт / Класс повреждения</th>
                                </tr>
                            </thead>
                            <tbody id="warehouseTbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Свод по брендам/размерам -->
                <div class="card">
                    <h3 class="card-title">Свод по шинам и размерам (по брендам)</h3>
                    <div class="summary-container" id="summaryContainer">
                        <table class="summary-table" id="summaryTable">
                            <thead id="summaryHead"></thead>
                            <tbody id="summaryBody"></tbody>
                            <tfoot id="summaryFoot"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- МОДАЛ перемещения (основной) -->
    <div class="modal-overlay" id="moveTireModal">
        <div class="modal" id="moveModal">
            <div class="modal-header">
                <h3>Перемещение шины</h3>
                <button class="modal-close" id="closeMoveModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="warning-message" id="replacementWarning" style="display:none;">
                    На этой позиции шина уже установлена. После подтверждения появится блок ввода для снятия текущей шины.
                </div>

                <div id="moveDestinationInfo" class="form-group"></div>

                <div class="form-group">
                    <label for="moveDate">Дата перемещения</label>
                    <input type="date" id="moveDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="moveTime">Время</label>
                    <input type="time" id="moveTime" class="form-control">
                </div>
                <div class="form-group">
                    <label for="moveState">Состояние (назначение)</label>
                    <select id="moveState" class="form-control">
                        <option value="эксплуатация">Эксплуатация</option>
                        <option value="ремонт">Ремонт</option>
                        <option value="резерв">Резерв</option>
                        <option value="нефункциональное">Нефункциональное</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="moveComment">Причина / комментарий</label>
                    <textarea id="moveComment" class="form-control" placeholder="Кратко опишите причину..."></textarea>
                </div>

                <!-- секция для снятия занятой шины -->
                <div class="replacement-section" id="replacementSection">
                    <h4>Перемещение текущей шины (снятой с позиции)</h4>
                    <div class="form-group">
                        <label for="replacementWarehouse">Склад назначения</label>
                        <select id="replacementWarehouse" class="form-control">
                            <option value="АТУ">АТУ</option>
                            <option value="МТР">МТР</option>
                            <option value="Оборот">Оборот</option>
                            <option value="Ремонт">Ремонт</option>
                            <option value="Отремонтированные">Отремонтированные</option>
                            <option value="Нефункциональные">Нефункциональные</option>
                            <option value="Списанные">Списанные</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="replacementState">Состояние снятой</label>
                        <select id="replacementState" class="form-control">
                            <option value="эксплуатация">Эксплуатация</option>
                            <option value="ремонт" selected>Ремонт</option>
                            <option value="резерв">Резерв</option>
                            <option value="нефункциональное">Нефункциональное</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="replacementReason">Причина снятия</label>
                        <textarea id="replacementReason" class="form-control" placeholder="Укажите причину снятия..."></textarea>
                    </div>
                    <div class="form-group">
                        <label for="replacementComment">Комментарий</label>
                        <textarea id="replacementComment" class="form-control" placeholder="Дополнительные детали..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelMove">Отмена</button>
                <button class="btn btn-primary" id="confirmMove">Подтвердить перемещение</button>
            </div>
        </div>
    </div>

    <!-- МОДАЛ подтверждения при занятой позиции -->
    <div class="modal-overlay" id="occupiedConfirmModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Позиция занята</h3>
                <button class="modal-close" id="closeOccupiedConfirm">&times;</button>
            </div>
            <div class="modal-body">
                Позиция уже занята другой шиной. Вы уверены, что хотите выполнить перемещение и снять текущую?
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="occupiedNo">Нет</button>
                <button class="btn btn-primary" id="occupiedYes">Да</button>
            </div>
        </div>
    </div>

    <script>
        // ===== ГЛОБАЛЬНОЕ СОСТОЯНИЕ =====
        let truckStore = {};
        let truckMetaStore = {};
        let warehouseStore = {};
        let currentDragData = null;
        let currentDropTarget = null;
        let currentWarehouse = "АТУ";
        let truckSortState = { key: 'id', dir: 'asc' };
        let activeTruckId = null;
        let occupiedPending = false;
        let pendingDragData = null;
        let pendingDropTarget = null;

        // ===== СПРАВОЧНИКИ =====
        const truckModels = ['БелАЗ 75131', 'БелАЗ 7513D', 'БелАЗ 75306', 'БелАЗ 7530G'];
        const tireBrands = ['MICHELIN', 'BRIDGESTONE', 'GOODYEAR', 'CONTINENTAL','Hankook'];
        const tireModels = ['XDR2', 'XDR3', 'VSDL', 'G177', 'L5'];
        const treadPatterns = ['Тяговый', 'Скальный', 'Карьерный', 'Универсальный'];
        const WAREHOUSE_SIZES = ["33.00-51", "33.00R51", "40.00-57", "40.00R57", "46/90R57"];
        const positions = ['ПП','ПЛ','ЗЛН','ЗЛВ','ЗПВ','ЗПН'];
        const WAREHOUSES = ["АТУ","МТР","Оборот","Ремонт","Отремонтированные","Нефункциональные","Списанные"];

        const SIZE_GROUP_51 = new Set(['33.00-51','33.00R51','33.00 R51']);
        const SIZE_GROUP_57 = new Set(['40.00-57','40.00R57','40.00 R57','46/90R57']);

        function normalizeSize(s){
            return s.replace(/\s+/g,'').replace('33.0051','33.00-51').replace('40.0057','40.00-57');
        }
        function getAllowedSizesByModel(model){
            if (model.includes('75131') || model.includes('7513')) return SIZE_GROUP_51;
            return SIZE_GROUP_57;
        }

        // ===== УТИЛИТЫ =====
        function getRandomInt(min,max){return Math.floor(Math.random()*(max-min+1))+min;}
        function daysBetween(d1,d2){
            if(!d1||!d2||isNaN(d1.getTime())||isNaN(d2.getTime())) return 0;
            return Math.ceil(Math.abs(d2-d1)/(1000*60*60*24));
        }
        function getDamageClassColor(d){
            switch(d){
                case 0: case 1: return 'damage-green';
                case 2: return 'damage-yellow';
                case 3: return 'damage-orange';
                case 4: return 'damage-gray';
                default: return '';
            }
        }
        function rand(seed){let x=Math.abs(seed)||1;return()=>{x=(1103515245*x+12345)&0x7fffffff;return x/0x7fffffff;}}
        function hash(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h+s.charCodeAt(i))|0;}return Math.abs(h)||1;}
        function pad(n,w=3){return String(n).padStart(w,'0');}

        // ===== ОЦЕНКИ/ПРЕДУПРЕЖДЕНИЯ =====
        function checkWarningConditions(arr){
            const pairs=[['ПП','ПЛ'],['ЗПН','ЗПВ'],['ЗЛН','ЗЛВ']];
            let differentPairs=false, inspectionOver14=false, wearOver90=false, damageOver2=false;
            pairs.forEach(p=>{
                const a=arr.find(t=>t.position===p[0]&&t.hasTire);
                const b=arr.find(t=>t.position===p[1]&&t.hasTire);
                if(a&&b){
                    if(a.brand!==b.brand||a.model!==b.model||a.pattern!==b.pattern||normalizeSize(a.size)!==normalizeSize(b.size)) 
                        differentPairs=true;
                }
            });
            arr.forEach(t=>{
                if(t.hasTire){
                    const [dd,mm,yy]=t.inspectionDate.split('.');
                    let d=new Date(`${yy}-${mm}-${dd}`); 
                    if(isNaN(d.getTime())) d=new Date();
                    if(daysBetween(d,new Date())>14) inspectionOver14=true;
                    if(t.wearPercentage>90) wearOver90=true;
                    if(t.damageClass>2) damageOver2=true;
                }
            });
            return differentPairs||inspectionOver14||wearOver90||damageOver2;
        }

        // ===== ГЕНЕРАЦИЯ ДАННЫХ =====
        function initializeTruckMeta(){
            truckMetaStore={};
            for(let i=1;i<=30;i++){
                const id=1100+i;
                const m = truckModels[(id % truckModels.length)];
                truckMetaStore[id] = { model: m, wheelbase: '2*4', allowed: getAllowedSizesByModel(m) };
            }
        }
        function initializeTruckStore(){
            truckStore={};
            for(let i=1;i<=30;i++){
                const truckId=1100+i;
                const actual=Math.random()>0.4?6:getRandomInt(4,5);
                truckStore[truckId]=[];
                const pos=[...positions];
                for(let j=0;j<actual&&pos.length;j++){
                    const idx=Math.floor(Math.random()*pos.length);
                    const position=pos.splice(idx,1)[0];
                    const brand=tireBrands[getRandomInt(0,tireBrands.length-1)];
                    const model=tireModels[getRandomInt(0,tireModels.length-1)];
                    const pattern=treadPatterns[getRandomInt(0,treadPatterns.length-1)];
                    const allowed=truckMetaStore[truckId].allowed;
                    let size = allowed===SIZE_GROUP_51 ? (Math.random()>0.5?'33.00-51':'33.00R51') : (['40.00-57','40.00R57','46/90R57'][getRandomInt(0,2)]);
                    const number='V'+getRandomInt(80000,99999)+String.fromCharCode(65+getRandomInt(0,5))+'5'+String.fromCharCode(65+getRandomInt(0,5));
                    const daysAgo=Math.random()>0.7?getRandomInt(15,30):getRandomInt(1,14);
                    const insp=new Date(); insp.setDate(insp.getDate()-daysAgo);
                    const total=getRandomInt(20000,40000);
                    const posKm=getRandomInt(100,300);
                    const initDepth=98;
                    const curr=getRandomInt(40,80);
                    const wear=Math.round(((initDepth-curr)/initDepth)*100);
                    const dmg=getRandomInt(0,4);
                    const wear30StartDays=getRandomInt(10,120);
                    const pressureDeviations=getRandomInt(0,6), pressureAvgMins=pressureDeviations?getRandomInt(5,40):0;
                    const speedExceeds=getRandomInt(0,10), speedTimeMin=speedExceeds?getRandomInt(3,60):0;
                    const tkvchExceeded=getRandomInt(0,15), tkvchTotal=getRandomInt(Math.max(tkvchExceeded,15),60);

                    truckStore[truckId].push({
                        id:`${truckId}-${position}`, truckId, position, brand, model, pattern, size, number,
                        inspectionDate: insp.toLocaleDateString('ru-RU'),
                        totalMileage: total, positionMileage: posKm,
                        initialDepth: initDepth, currentDepth: curr, wearPercentage: wear,
                        damageClass: dmg, hasTire:true,
                        meta:{ wear30SinceDays: wear>=30 ? wear30StartDays : 0, tkvchExceeded, tkvchTotal,
                               pressureDeviations, pressureAvgMins, speedExceeds, speedTimeMin }
                    });
                }
            }
        }

        const WAREHOUSE_BRANDS=["Michelin","Bridgestone","Goodyear","Continental","Hankook"];
        const WAREHOUSE_MODELS=["XDR2","XDR3","VSDL","G177","L5"];
        const WAREHOUSE_PATTERNS=["Тяговый","Скальный","Карьерный","Универсальный"];
        const LOCKSMITHS=["Иванов А.А.","Петров В.В."];

        function generateRepairInfo(r){
            const repaired=r()>0.4;
            if(!repaired) return {repaired:false,repairText:"нет"};
            const start=new Date(); start.setDate(start.getDate()-getRandomInt(30,180));
            const end=new Date(start); end.setDate(end.getDate()+getRandomInt(1,5));
            return { repaired:true, repairText:"ДА",
                repairDetails:{ actNumber:getRandomInt(1000,2000),
                    startDate:start.toLocaleDateString('ru-RU'), endDate:end.toLocaleDateString('ru-RU'),
                    repairCount:getRandomInt(1,3), mileageAfterRepair:getRandomInt(15000,35000),
                    locksmith:LOCKSMITHS[Math.floor(r()*LOCKSMITHS.length)] } };
        }
        function generateWarehouseData(warehouse,count=12){
            const r=rand(hash(warehouse)); const arr=[];
            for(let i=0;i<count;i++){
                const brand=WAREHOUSE_BRANDS[Math.floor(r()*WAREHOUSE_BRANDS.length)];
                const model=WAREHOUSE_MODELS[Math.floor(r()*WAREHOUSE_MODELS.length)];
                const pattern=WAREHOUSE_PATTERNS[Math.floor(r()*WAREHOUSE_PATTERNS.length)];
                const size=WAREHOUSE_SIZES[Math.floor(r()*WAREHOUSE_SIZES.length)];
                const mileage=Math.floor(30000+r()*110000);
                const wear=Math.min(95,Math.floor(r()*35)+(mileage>90000?25:10));
                const plan=+(16+r()*8).toFixed(1);
                const fact=+(plan-(wear/10)).toFixed(1);
                const rep=generateRepairInfo(r);
                const dmgNum = wear<30?1 : wear<60?2 : wear<90?3 : 4;

                arr.push({
                    id:`warehouse-${warehouse}-${i}`,
                    substock:`${warehouse}-${1+Math.floor(r()*3)}`,
                    row:["A","B","C","D"][Math.floor(r()*4)],
                    place:1+Math.floor(r()*24),
                    number:warehouse.slice(0,2).toUpperCase()+"-"+pad(1+Math.floor(r()*999)),
                    brand, model, pattern, size, mileage,
                    condition:mileage>80000?'в эксплуатации':'на хранении',
                    planOGP:plan, factOGP:fact, wearPercentage:wear,
                    repaired:rep.repaired, repairText:rep.repairText, repairDetails:rep.repairDetails,
                    damageClassNumeric:dmgNum
                });
            }
            return arr;
        }

        // ===== СВОД =====
        function renderSummary(){
            const head=document.getElementById('summaryHead');
            const body=document.getElementById('summaryBody');
            const foot=document.getElementById('summaryFoot');
            let allTires=[];
            Object.values(truckStore).forEach(truckTires=>truckTires.forEach(t=>{if(t.hasTire){allTires.push({brand:t.brand,size:normalizeSize(t.size)})}}));
            Object.values(warehouseStore).forEach(warehouseTires=>warehouseTires.forEach(t=>allTires.push({brand:t.brand,size:normalizeSize(t.size)})));
            const brands=[...new Set(allTires.map(t=>t.brand))].sort();
            const sizes=[...new Set(allTires.map(t=>t.size))].sort();
            const summaryData={}; brands.forEach(b=>{summaryData[b]={}; sizes.forEach(s=>summaryData[b][s]=0);});
            allTires.forEach(t=>summaryData[t.brand][t.size]++);
            head.innerHTML=''; const hr=document.createElement('tr'); const eTh=document.createElement('th'); eTh.textContent='Бренд / Размер'; hr.appendChild(eTh);
            sizes.forEach(s=>{const th=document.createElement('th'); th.textContent=s; hr.appendChild(th)}); head.appendChild(hr);
            body.innerHTML=''; brands.forEach(b=>{const r=document.createElement('tr'); const c=document.createElement('td'); c.textContent=b; c.style.fontWeight='bold'; r.appendChild(c);
                sizes.forEach(s=>{const n=summaryData[b][s]||0; const td=document.createElement('td'); td.textContent=n; if(n>0){td.style.fontWeight='bold'; td.style.background='#e3f2fd'} r.appendChild(td);}); body.appendChild(r);});
            foot.innerHTML=''; const fr=document.createElement('tr'); const tl=document.createElement('td'); tl.textContent='Всего'; tl.style.fontWeight='bold'; fr.appendChild(tl);
            sizes.forEach(s=>{const total=brands.reduce((sum,b)=>sum+(summaryData[b][s]||0),0); const td=document.createElement('td'); td.textContent=total; td.style.fontWeight='bold'; td.style.background='#d4edda'; fr.appendChild(td);}); foot.appendChild(fr);
        }

        // ===== ТАБЛИЦА САМОСВАЛОВ =====
        function generateTireData(truckId){
            let html=''; const arr=truckStore[truckId]||[];
            html+=`<tr class="tire-position-header">
                <th class="position-header">Позиция / Номер / Дата осмотра</th>
                <th>Бренд / Модель / Рисунок</th>
                <th>Размер / Пробег факт / Пробег на позиции</th>
                <th>ОГП план / ОГП факт / % износа</th>
                <th>Класс повреждения</th></tr>`;
            const positionsOrder=['ПП','ПЛ','ЗЛН','ЗЛВ','ЗПВ','ЗПН'];
            positionsOrder.forEach((pos,idx)=>{
                const t=arr.find(x=>x.position===pos);
                const even=idx%2===0; const last=idx===positionsOrder.length-1;
                if(t){
                    const color=getDamageClassColor(t.damageClass);
                    const [dd,mm,yy]=t.inspectionDate.split('.');
                    let d=new Date(`${yy}-${mm}-${dd}`); if(isNaN(d.getTime())) d=new Date();
                    const daysSince=daysBetween(d,new Date());
                    const rotationDays=t.meta.wear30SinceDays||0;
                    const pairMap={ПП:'ПЛ',ПЛ:'ПП',ЗЛН:'ЗЛВ',ЗЛВ:'ЗЛН',ЗПВ:'ЗПН',ЗПН:'ЗПВ'};
                    let mismatch='—'; const pair=arr.find(x=>x.position===pairMap[t.position]);
                    if(pair){
                        const eq=t.brand===pair.brand && t.model===pair.model && t.pattern===pair.pattern && normalizeSize(t.size)===normalizeSize(pair.size);
                        mismatch=eq?'нет':'да';
                    }
                    const infoHTML=`<div class="tooltip-text">
                        <strong>Инфо по шине ${t.number}</strong><br>
                        Дней с последнего осмотра: ${daysSince}<br>
                        Ротация (с 30% износа): ${rotationDays} дн.<br>
                        Несоответствие позиции: ${mismatch}<br>
                        ТКВЧ: ${t.meta.tkvchExceeded}/${t.meta.tkvchTotal}<br>
                        Давление: отклонений ${t.meta.pressureDeviations} / ср. длит. ${t.meta.pressureAvgMins} мин<br>
                        Скорость: превышений ${t.meta.speedExceeds} / всего ${t.meta.speedTimeMin} мин
                    </div>`;
                    html+=`<tr class="tire-draggable ${even?'even':'odd'}" draggable="true" data-tire-id="${t.id}" data-truck-id="${truckId}" data-position="${pos}">
                        <td colspan="5" class="tire-block-container">
                            <div class="tire-details-table-container">
                                <table class="tire-details-table" style="width:100%">
                                    <tbody>
                                        <tr>
                                            <td>${pos}</td>
                                            <td>${t.brand}</td>
                                            <td>${t.size}</td>
                                            <td>${t.initialDepth} мм</td>
                                            <td rowspan="3" class="${color}">${t.damageClass}</td>
                                        </tr>
                                        <tr>
                                            <td><span class="repair-tooltip tire-num">${t.number}${infoHTML}</span></td>
                                            <td>${t.model}</td>
                                            <td>${t.totalMileage.toLocaleString('ru-RU')} км</td>
                                            <td>${t.currentDepth} мм</td>
                                        </tr>
                                        <tr class="${last?'':'tire-block'}">
                                            <td>${t.inspectionDate}</td>
                                            <td>${t.pattern}</td>
                                            <td>${t.positionMileage.toLocaleString('ru-RU')} км</td>
                                            <td>${t.wearPercentage}%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>`;
                } else {
                    html+=`<tr class="empty-tire position-drop-zone ${even?'even':'odd'}" data-truck-id="${truckId}" data-position="${pos}">
                        <td colspan="5" class="tire-block-container">
                            <div class="tire-details-table-container">
                                <table class="tire-details-table" style="width:100%">
                                    <tbody>
                                        <tr>
                                            <td>${pos}</td><td>-</td><td>-</td><td>-</td><td rowspan="3">-</td>
                                        </tr>
                                        <tr>
                                            <td>-</td><td>-</td><td>-</td><td>-</td>
                                        </tr>
                                        <tr class="${last?'':'tire-block'}">
                                            <td>-</td><td>-</td><td>-</td><td>-</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </td>
                    </tr>`;
                }
            });
            return { html, tireDataArray: arr };
        }

        function generateTrucks(){
            const tbody=document.getElementById('trucks-table-body');
            const container=document.getElementById('trucksListContainer');
            container.classList.remove('expanded');

            let trucksArr=[];
            for(let i=1;i<=30;i++){
                const truckId=1100+i;
                const meta=truckMetaStore[truckId];
                const plan=6;
                const actual=truckStore[truckId]?truckStore[truckId].length:0;
                const {html:tireHtml,tireDataArray}=generateTireData(truckId);
                const needsAttention=actual<plan||checkWarningConditions(tireDataArray);
                const status=needsAttention&&Math.random()>0.3?'<span class="warning-indicator">!!!</span>':'✅';
                trucksArr.push({truckId, model:meta.model, wheelbase:meta.wheelbase, planTires:plan, actualTires:actual, status, statusOrder:status.includes('!!!')?1:0, tireHtml});
            }

            trucksArr.sort((a,b)=>{
                let av,bv;
                switch(truckSortState.key){
                    case 'id': av=a.truckId; bv=b.truckId; break;
                    case 'model': av=a.model; bv=b.model; break;
                    case 'wheelbase': av=a.wheelbase; bv=b.wheelbase; break;
                    case 'tiresCount': av=a.actualTires; bv=b.actualTires; break;
                    case 'status': av=a.statusOrder; bv=b.statusOrder; break;
                    default: av=a.truckId; bv=b.truckId;
                }
                if(av<bv) return truckSortState.dir==='asc'?-1:1;
                if(av>bv) return truckSortState.dir==='asc'?1:-1;
                return 0;
            });

            let html='';
            for(const t of trucksArr){
                html+=`<tr class="truck-row" data-truck="${t.truckId}">
                    <td>${t.truckId}</td><td>${t.model}</td><td>${t.wheelbase}</td>
                    <td>${t.planTires}/${t.actualTires}</td><td>${t.status}</td></tr>
                <tr class="tires-details-container" id="tires-${t.truckId}">
                    <td colspan="5" class="tire-details-cell">
                        <div class="tire-details-table-container">
                            <table class="tire-details-table"><tbody>${t.tireHtml}</tbody></table>
                        </div>
                    </td>
                </tr>`;
            }
            tbody.innerHTML=html;

            document.querySelectorAll('.truck-row').forEach(row=>{
                row.addEventListener('click',function(){
                    const truckId=this.getAttribute('data-truck');
                    const details=document.getElementById(`tires-${truckId}`);
                    const isExp=details.classList.contains('expanded');
                    document.querySelectorAll('.tires-details-container').forEach(d=>d.classList.remove('expanded'));
                    document.querySelectorAll('.truck-row').forEach(r=>r.classList.remove('active'));
                    container.classList.remove('expanded');
                    if(!isExp){ details.classList.add('expanded'); this.classList.add('active'); container.classList.add('expanded'); activeTruckId=truckId; }
                    else { activeTruckId=null; }
                });
            });

            if(activeTruckId){
                const r=document.querySelector(`.truck-row[data-truck="${activeTruckId}"]`);
                const d=document.getElementById(`tires-${activeTruckId}`);
                if(r&&d){ r.classList.add('active'); d.classList.add('expanded'); container.classList.add('expanded'); }
                else { activeTruckId=null; container.classList.remove('expanded'); }
            }

            updateTruckSortIndicators();
            initDragAndDrop();
            renderSummary();
        }
        function updateTruckSortIndicators(){
            document.querySelectorAll('.truck-table th.sortable').forEach(th=>{
                const key=th.getAttribute('data-key');
                th.className=`sortable${key===truckSortState.key?` ${truckSortState.dir}`:''}`;
            });
        }

        // ===== СКЛАД =====
        function renderWarehouseTabs(){
            const c=document.getElementById('warehouseTabs'); c.innerHTML='';
            WAREHOUSES.forEach(w=>{
                const tab=document.createElement('div'); 
                tab.className=`warehouse-tab ${w===currentWarehouse?'active':''}`; 
                tab.textContent=w;
                tab.addEventListener('click',()=>{ currentWarehouse=w; renderWarehouseTabs(); renderWarehouseTable(); renderSummary(); });
                c.appendChild(tab);
            });
        }

        let sortState={key:'substock',dir:'asc'};
        function getSortValue(item,key){
            switch(key){
                case 'substock': return item.substock;
                case 'row': return item.row;
                case 'place': return +item.place;
                case 'number': return item.number;
                case 'brand': return item.brand;
                case 'size': return item.size;
                case 'ogp': return item.planOGP;
                case 'repair': return item.repaired;
                default: return '';
            }
        }
        function buildRepairCellHTML(item){
            if(item.repaired && item.repairDetails){
                return `<span class="repair-tooltip repair-yes">ДА
                    <div class="tooltip-text">
                        <strong>Инфо о ремонте</strong><br>
                        Номер акта: ${item.repairDetails.actNumber}<br>
                        Дата начала: ${item.repairDetails.startDate}<br>
                        Дата окончания: ${item.repairDetails.endDate}<br>
                        Кол-во ремонтов: ${item.repairDetails.repairCount}<br>
                        Пробег после ремонта: ${item.repairDetails.mileageAfterRepair.toLocaleString('ru-RU')} км<br>
                        Слесарь: ${item.repairDetails.locksmith}
                    </div>
                </span>`;
            }
            return `<span>нет</span>`;
        }
        function buildDamageBadge(num){
            const cls=getDamageClassColor(num);
            return `<span class="repair-tooltip ${cls}" style="padding:2px 6px;display:inline-block;margin-left:6px;">
                ${num}
                <div class="tooltip-text">
                    <strong>Классификация повреждений КГШ</strong><br>
                    1 — косметические, эксплуатация<br>
                    2 — наблюдать<br>
                    3 — критично, рассмотреть ремонт<br>
                    4 — предельный износ / не принимать
                </div>
            </span>`;
        }
        function renderWarehouseTable(){
            const tbody=document.getElementById('warehouseTbody');
            const data=[...warehouseStore[currentWarehouse]];
            data.sort((a,b)=>{const av=getSortValue(a,sortState.key), bv=getSortValue(b,sortState.key); if(av<bv) return sortState.dir==='asc'?-1:1; if(av>bv) return sortState.dir==='asc'?1:-1; return 0;});
            tbody.innerHTML='';
            data.forEach((item,index)=>{
                const tr=document.createElement('tr');
                tr.className=`tire-draggable ${index%2===0?'even':'odd'}`;
                tr.setAttribute('draggable','true');
                tr.setAttribute('data-tire-id',item.id);
                tr.setAttribute('data-warehouse',currentWarehouse);
                tr.innerHTML=`
                    <td>${item.substock}</td>
                    <td>${item.row}</td>
                    <td>${item.place}</td>
                    <td>${item.number}</td>
                    <td>${item.brand} / ${item.model} / ${item.pattern}</td>
                    <td>${item.size} / ${item.mileage.toLocaleString('ru-RU')} км / ${item.condition}</td>
                    <td>${item.planOGP} мм / ${item.factOGP} мм / ${item.wearPercentage}%</td>
                    <td>${buildRepairCellHTML(item)} ${buildDamageBadge(item.damageClassNumeric)}</td>`;
                tbody.appendChild(tr);
            });
            document.querySelectorAll('#warehouseTable th.sortable').forEach(th=>{
                const key=th.dataset.key; th.className=`sortable${key===sortState.key?` ${sortState.dir}`:''}`;
            });
            initDragAndDrop();
        }

        // ===== DRAG & DROP (обновлено) =====
        function initDragAndDrop(){
            // источники
            document.querySelectorAll('.tire-draggable').forEach(el=>{
                el.removeEventListener('dragstart',handleDragStart);
                el.removeEventListener('dragend',handleDragEnd);
                el.addEventListener('dragstart',handleDragStart);
                el.addEventListener('dragend',handleDragEnd);
            });

            // пустые позиции
            document.querySelectorAll('.position-drop-zone').forEach(el=>{
                el.removeEventListener('dragover',handleDragOver);
                el.removeEventListener('dragenter',handleDragEnter);
                el.removeEventListener('dragleave',handleDragLeave);
                el.removeEventListener('drop',handleDrop);
                el.addEventListener('dragover',handleDragOver);
                el.addEventListener('dragenter',handleDragEnter);
                el.addEventListener('dragleave',handleDragLeave);
                el.addEventListener('drop',handleDrop);
            });

            // КОНТЕЙНЕРЫ занятых позиций (ключ к замене)
            document.querySelectorAll('.tire-details-table-container').forEach(el=>{
                el.removeEventListener('dragover',handleDragOver);
                el.removeEventListener('dragenter',onContainerEnter);
                el.removeEventListener('dragleave',onContainerLeave);
                el.removeEventListener('drop',handleDrop);
                el.addEventListener('dragover',handleDragOver);
                el.addEventListener('dragenter',onContainerEnter);
                el.addEventListener('dragleave',onContainerLeave);
                el.addEventListener('drop',handleDrop);
            });
            function onContainerEnter(e){ e.preventDefault(); this.classList.add('drag-over'); }
            function onContainerLeave(){ this.classList.remove('drag-over'); }

            // область склада
            const wh=document.getElementById('warehouseTableContainer');
            if(wh){
                wh.removeEventListener('dragover',handleDragOver);
                wh.removeEventListener('drop',handleDrop);
                wh.addEventListener('dragover',handleDragOver);
                wh.addEventListener('drop',handleDrop);
            }
        }
        function handleDragStart(e){
            const row=e.currentTarget;
            const tireId=row.getAttribute('data-tire-id'); if(!tireId) return;
            const isTruck=!!row.closest('.tire-details-table-container');
            let source=isTruck?'truck':'warehouse';
            let warehouseAttr=isTruck?null:(row.getAttribute('data-warehouse')||currentWarehouse);
            currentDragData={tireId,source,warehouse:warehouseAttr};
            row.classList.add('dragging');
            e.dataTransfer.setData('text/plain',tireId);
            e.dataTransfer.effectAllowed='move';
        }
        function handleDragEnd(e){
            e.currentTarget.classList.remove('dragging');
            cleanupDropHighlights();
        }
        function handleDragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect='move'; }
        function handleDragEnter(e){ const t=e.target.closest('.position-drop-zone'); if(t) t.classList.add('drag-over'); }
        function handleDragLeave(e){ const t=e.target.closest('.position-drop-zone'); if(t) t.classList.remove('drag-over'); }

        function handleDrop(e){
            e.preventDefault();
            if(!currentDragData) return;

            // 1) Пустая позиция
            const zone=e.target.closest('.position-drop-zone');
            if(zone){
                const truckId=zone.getAttribute('data-truck-id');
                const position=zone.getAttribute('data-position');
                const existingTire=(truckStore[truckId]||[]).find(t=>t.position===position);
                currentDropTarget={type:'truck',truckId,position};
                if(existingTire){
                    pendingDragData={...currentDragData};
                    pendingDropTarget={...currentDropTarget};
                    openOccupiedConfirm();
                }else{
                    openMoveModal({needReplacement:false});
                }
                cleanupDropHighlights();
                return;
            }

            // 2) Занятая позиция (дроп по контейнеру)
            const cont=e.target.closest('.tire-details-table-container');
            if(cont){
                const tiresContainer=cont.closest('.tires-details-container'); // tr#tires-XXXX
                let truckId=null, position=null;
                if(tiresContainer){ truckId=String(tiresContainer.id||'').replace('tires-',''); }
                const posCell=cont.querySelector('tbody tr:first-child td:first-child');
                if(posCell) position=posCell.textContent.trim();
                if(truckId && position){
                    currentDropTarget={type:'truck',truckId,position};
                    pendingDragData={...currentDragData};
                    pendingDropTarget={...currentDropTarget};
                    openOccupiedConfirm();
                }
                cleanupDropHighlights();
                return;
            }

            // 3) Область склада
            const whc=document.getElementById('warehouseTableContainer');
            if(whc && (e.target===whc || whc.contains(e.target))){
                currentDropTarget={type:'warehouse',warehouse:currentWarehouse};
                openMoveModal({needReplacement:false});
            }
            cleanupDropHighlights();
        }
        function cleanupDropHighlights(){
            document.querySelectorAll('.position-drop-zone').forEach(el=>el.classList.remove('drag-over'));
            document.querySelectorAll('.tire-details-table-container').forEach(el=>el.classList.remove('drag-over'));
        }

        // ===== МОДАЛЫ =====
        function openOccupiedConfirm(){ document.getElementById('occupiedConfirmModal').classList.add('active'); }
        function closeOccupiedConfirm(){
            document.getElementById('occupiedConfirmModal').classList.remove('active');
            occupiedPending=false; pendingDragData=null; pendingDropTarget=null;
        }
        function openMoveModal({needReplacement}){
            const modal=document.getElementById('moveTireModal');
            const moveModal=document.getElementById('moveModal');
            const info=document.getElementById('moveDestinationInfo');
            const replacementWarning=document.getElementById('replacementWarning');
            const replacementSection=document.getElementById('replacementSection');
            const text=currentDropTarget.type==='truck'
                ? `Назначение: самосвал <b>${currentDropTarget.truckId}</b>, позиция <b>${currentDropTarget.position}</b>`
                : `Назначение: склад <b>${currentDropTarget.warehouse}</b>`;
            info.innerHTML=text;
            const now=new Date();
            document.getElementById('moveDate').value=now.toISOString().split('T')[0];
            document.getElementById('moveTime').value=now.toTimeString().slice(0,5);
            document.getElementById('moveState').value=currentDropTarget.type==='truck'?'эксплуатация':'резерв';
            document.getElementById('moveComment').value='';
            replacementWarning.style.display='none';
            replacementSection.classList.remove('active');
            moveModal.classList.remove('wide');
            if(needReplacement){
                replacementWarning.style.display='block';
                replacementSection.classList.add('active');
                moveModal.classList.add('wide');
                document.getElementById('replacementWarehouse').value='АТУ';
                document.getElementById('replacementState').value='ремонт';
                document.getElementById('replacementReason').value='';
                document.getElementById('replacementComment').value='';
            }
            modal.classList.add('active');
        }
        function closeMoveModal(){
            document.getElementById('moveTireModal').classList.remove('active');
            currentDragData=null; currentDropTarget=null;
        }
        function confirmMove(){
            if(!currentDragData || !currentDropTarget){ 
                alert('Ошибка: данные о перемещении отсутствуют'); 
                return; 
            }
            const date=document.getElementById('moveDate').value;
            const time=document.getElementById('moveTime').value||'00:00';
            const comment=document.getElementById('moveComment').value||'';
            const moveState=(document.getElementById('moveState').value||'').toLowerCase();
            if(!date){ alert('Укажите дату'); return; }
            const replacementActive=document.getElementById('replacementSection').classList.contains('active');
            let replacement=null;
            if(replacementActive){
                const replacementWarehouse=document.getElementById('replacementWarehouse').value;
                const replacementState=(document.getElementById('replacementState').value||'').toLowerCase();
                const replacementReason=document.getElementById('replacementReason').value||'';
                const replacementComment=document.getElementById('replacementComment').value||'';
                if(!replacementReason){ alert('Укажите причину снятия текущей шины'); return; }
                replacement={replacementWarehouse,replacementState,replacementReason,replacementComment};
            }
            
            try {
                performTireMove(currentDragData, currentDropTarget, {date, time, comment, moveState, replacement});
                closeMoveModal();
            } catch(err) { 
                console.error('Ошибка при перемещении:', err);
                alert('Произошла ошибка при перемещении: ' + err.message); 
            }
        }

        // ===== ПЕРЕМЕЩЕНИЯ =====
        function performTireMove(dragData, dropTarget, payload){
            const rerenderAll=()=>{ 
                generateTrucks(); 
                renderWarehouseTable(); 
                renderSummary(); 
            };

            // Самосвал -> Склад
            if(dragData.source==='truck' && dropTarget.type==='warehouse'){
                const [truckId, position]=dragData.tireId.split('-');
                const arr=truckStore[truckId]||[];
                const idx=arr.findIndex(t=>t.position===position);
                if(idx!==-1){
                    const t=arr[idx]; 
                    arr.splice(idx,1);
                    warehouseStore[dropTarget.warehouse].push({
                        ...t,
                        id:`warehouse-${dropTarget.warehouse}-${Date.now()}`,
                        substock:`${dropTarget.warehouse}-${1+Math.floor(Math.random()*3)}`,
                        row:["A","B","C","D"][Math.floor(Math.random()*4)],
                        place:1+Math.floor(Math.random()*24),
                        condition:payload.moveState,
                        planOGP:t.initialDepth, 
                        factOGP:t.currentDepth,
                        repaired:t.repaired??false, 
                        repairText:(t.repaired?'ДА':'нет'),
                        damageClassNumeric:Math.min(4,Math.max(1,Math.round((t.wearPercentage||0)/25)))
                    });
                    rerenderAll();
                    alert(`Шина перемещена на склад "${dropTarget.warehouse}".\n${payload.date} ${payload.time}\nСостояние: ${payload.moveState}\nКомментарий: ${payload.comment}`);
                }
                return;
            }

            // Склад -> Самосвал
            if(dragData.source==='warehouse' && dropTarget.type==='truck'){
                const srcWarehouse=dragData.warehouse||currentWarehouse;
                const list=warehouseStore[srcWarehouse];
                const idx=list.findIndex(x=>x.id===dragData.tireId);
                if(idx===-1){ 
                    throw new Error('Шина не найдена на исходном складе'); 
                }
                const item=list[idx];

                const allowed=truckMetaStore[dropTarget.truckId].allowed;
                const sizeNorm=normalizeSize(item.size);
                if(!allowed.has(sizeNorm)){ 
                    throw new Error(`Нельзя установить размер ${item.size} на модель ${truckMetaStore[dropTarget.truckId].model}.`); 
                }

                // Проверяем, есть ли уже шина на этой позиции
                const existing=(truckStore[dropTarget.truckId]||[]).find(t=>t.position===dropTarget.position);
                
                // Если есть замена и позиция занята
                if(payload.replacement && existing){
                    const truckArr=truckStore[dropTarget.truckId];
                    const exIndex=truckArr.findIndex(t=>t.id===existing.id);
                    if(exIndex!==-1) {
                        truckArr.splice(exIndex,1);
                        warehouseStore[payload.replacement.replacementWarehouse].push({
                            ...existing,
                            id:`warehouse-${payload.replacement.replacementWarehouse}-${Date.now()}`,
                            substock:`${payload.replacement.replacementWarehouse}-${1+Math.floor(Math.random()*3)}`,
                            row:["A","B","C","D"][Math.floor(Math.random()*4)],
                            place:1+Math.floor(Math.random()*24),
                            condition:payload.replacement.replacementState,
                            planOGP:existing.initialDepth, 
                            factOGP:existing.currentDepth,
                            repaired:existing.repaired??false, 
                            repairText:(existing.repaired?'ДА':'нет'),
                            damageClassNumeric:Math.min(4,Math.max(1,Math.round((existing.wearPercentage||0)/25))),
                            replacementMeta:{
                                reason:payload.replacement.replacementReason,
                                comment:payload.replacement.replacementComment
                            }
                        });
                    }
                } else if (existing && !payload.replacement) {
                    // Если позиция занята, но не было подтверждения замены
                    throw new Error('Позиция занята. Повторите перенос с подтверждением.');
                }

                list.splice(idx,1);
                const newTire={ 
                    id:`${dropTarget.truckId}-${dropTarget.position}`, 
                    truckId:dropTarget.truckId, 
                    position:dropTarget.position,
                    brand:item.brand, 
                    model:item.model, 
                    pattern:item.pattern, 
                    size:item.size, 
                    number:item.number,
                    inspectionDate:new Date().toLocaleDateString('ru-RU'),
                    totalMileage:item.mileage||0, 
                    positionMileage:0,
                    initialDepth:item.planOGP, 
                    currentDepth:item.factOGP,
                    wearPercentage:item.wearPercentage, 
                    damageClass:item.damageClassNumeric??1, 
                    hasTire:true,
                    meta:{ 
                        wear30SinceDays:item.wearPercentage>=30?getRandomInt(5,120):0,
                        tkvchExceeded:getRandomInt(0,10), 
                        tkvchTotal:getRandomInt(20,60),
                        pressureDeviations:getRandomInt(0,6), 
                        pressureAvgMins:getRandomInt(0,40),
                        speedExceeds:getRandomInt(0,8), 
                        speedTimeMin:getRandomInt(0,50) 
                    } 
                };
                
                if(!truckStore[dropTarget.truckId]) truckStore[dropTarget.truckId]=[];
                truckStore[dropTarget.truckId].push(newTire);
                activeTruckId=String(dropTarget.truckId);
                rerenderAll();
                alert(`Шина установлена на самосвал ${dropTarget.truckId} (${dropTarget.position}).\n${payload.date} ${payload.time}\nКомментарий: ${payload.comment}`);
                return;
            }

            // Склад -> Склад
            if(dragData.source==='warehouse' && dropTarget.type==='warehouse'){
                const src=dragData.warehouse||currentWarehouse;
                const dst=dropTarget.warehouse;
                const srcList=warehouseStore[src];
                const idx=srcList.findIndex(x=>x.id===dragData.tireId);
                if(idx===-1){ 
                    throw new Error('Шина не найдена на исходном складе'); 
                }
                const t=srcList[idx]; 
                srcList.splice(idx,1);
                warehouseStore[dst].push({
                    ...t, 
                    id:`warehouse-${dst}-${Date.now()}`,
                    substock:`${dst}-${1+Math.floor(Math.random()*3)}`,
                    row:["A","B","C","D"][Math.floor(Math.random()*4)],
                    place:1+Math.floor(Math.random()*24),
                    condition:payload.moveState
                });
                renderWarehouseTable(); 
                renderSummary();
                alert(`Шина перемещена: ${src} → ${dst}\n${payload.date} ${payload.time}\nСостояние: ${payload.moveState}\nКомментарий: ${payload.comment}`);
                return;
            }
            
            throw new Error('Неизвестный тип перемещения');
        }

        // ===== ПОИСК =====
        function initSearch(){
            const searchInput=document.getElementById('tireSearch');
            const searchResults=document.getElementById('searchResults');
            searchInput.addEventListener('input',function(){
                const query=this.value.trim();
                searchResults.innerHTML='';
                if(query.length<2){ searchResults.style.display='none'; return; }
                const allTires=[];
                Object.values(warehouseStore).forEach(wh=>wh.forEach(t=>allTires.push(t)));
                Object.values(truckStore).forEach(tt=>tt.forEach(t=>allTires.push(t)));
                const filtered=allTires.filter(t=>(t.number||'').toLowerCase().includes(query.toLowerCase()));
                if(filtered.length>0){
                    filtered.forEach(tire=>{
                        const div=document.createElement('div');
                        div.className='search-result-item';
                        div.textContent=`${tire.number} - ${(tire.brand||'')} ${(tire.model||'')} (${tire.size||''})`;
                        div.addEventListener('click',()=>{ 
                            searchInput.value=tire.number; 
                            searchResults.style.display='none'; 
                            highlightTire(tire.id); 
                        });
                        searchResults.appendChild(div);
                    });
                    searchResults.style.display='block';
                } else { searchResults.style.display='none'; }
            });
            document.addEventListener('click',function(e){
                if(!searchInput.contains(e.target) && !searchResults.contains(e.target)){ 
                    searchResults.style.display='none'; 
                }
            });
        }
        function highlightTire(tireId){
            document.querySelectorAll('.highlighted').forEach(el=>el.classList.remove('highlighted'));
            const whRows=document.querySelectorAll('#warehouseTbody tr');
            for(let i=0;i<whRows.length;i++){
                if(whRows[i].getAttribute('data-tire-id')===tireId){ 
                    whRows[i].classList.add('highlighted'); 
                    whRows[i].scrollIntoView({behavior:'smooth',block:'center'}); 
                    return; 
                }
            }
            const truckRows=document.querySelectorAll('.tire-draggable');
            for(let i=0;i<truckRows.length;i++){
                if(truckRows[i].getAttribute('data-tire-id')===tireId){ 
                    truckRows[i].classList.add('highlighted'); 
                    truckRows[i].scrollIntoView({behavior:'smooth',block:'center'}); 
                    return; 
                }
            }
        }

        // ===== СОРТИРОВКА/МЕНЮ =====
        function initSortingAndMenu(){
            document.querySelectorAll('.truck-table th.sortable').forEach(th=>{
                th.addEventListener('click',()=>{
                    const key=th.getAttribute('data-key');
                    if(truckSortState.key===key){ 
                        truckSortState.dir=truckSortState.dir==='asc'?'desc':'asc'; 
                    } else { 
                        truckSortState.key=key; 
                        truckSortState.dir='asc'; 
                    }
                    generateTrucks();
                });
            });
            document.querySelectorAll('#warehouseTable th.sortable').forEach(th=>{
                th.addEventListener('click',()=>{
                    const key=th.dataset.key;
                    if(sortState.key===key){ 
                        sortState.dir=sortState.dir==='asc'?'desc':'asc'; 
                    } else { 
                        sortState.key=key; 
                        sortState.dir='asc'; 
                    }
                    renderWarehouseTable();
                });
            });
            document.getElementById('menuButton').addEventListener('click',()=>{ 
                document.getElementById('menuDropdown').classList.toggle('show'); 
            });
            document.addEventListener('click',function(e){
                const btn=document.getElementById('menuButton'); 
                const dd=document.getElementById('menuDropdown');
                if(!btn.contains(e.target) && !dd.contains(e.target)){ 
                    dd.classList.remove('show'); 
                }
            });
            document.getElementById('btnRecs').addEventListener('click',()=>alert('Функционал рекомендаций будет реализован позже'));
            document.getElementById('btnAdd').addEventListener('click',()=>alert('Функционал добавления будет реализован позже'));
            document.getElementById('btnFilter').addEventListener('click',()=>alert('Функционал фильтра будет реализован позже'));
        }
        function navigateTo(section){ 
            alert(`Переход к разделу: ${section}`); 
            document.getElementById('menuDropdown').classList.remove('show'); 
        }

        // ===== ОБРАБОТЧИКИ МОДАЛОВ =====
        document.getElementById('closeOccupiedConfirm').addEventListener('click',closeOccupiedConfirm);
        document.getElementById('occupiedNo').addEventListener('click',closeOccupiedConfirm);
        document.getElementById('occupiedYes').addEventListener('click',()=>{
            currentDragData={...pendingDragData};
            currentDropTarget={...pendingDropTarget};
            closeOccupiedConfirm();
            openMoveModal({needReplacement:true});
        });
        document.getElementById('closeMoveModal').addEventListener('click',closeMoveModal);
        document.getElementById('cancelMove').addEventListener('click',closeMoveModal);
        document.getElementById('confirmMove').addEventListener('click',confirmMove);

        // ===== ЗАПУСК =====
        document.addEventListener('DOMContentLoaded',function(){
            initializeTruckMeta();
            initializeTruckStore();
            warehouseStore=Object.fromEntries(WAREHOUSES.map(w=>[w,generateWarehouseData(w)]));
            renderWarehouseTabs();
            renderWarehouseTable();
            initSortingAndMenu();
            initSearch();
            generateTrucks();
            setTimeout(()=>{ initDragAndDrop(); },100);
        });
    </script>
</body>
</html>
