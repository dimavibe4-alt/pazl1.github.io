<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ПАЗЛ — Главный экран</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.5;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1a2b47, #2c3e50);
            color: white;
            padding: 1.2rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-title-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            height: 100px;
            width: auto;
            cursor: pointer;
            transition: all 0.5s ease;
            border-radius: 8px;
            filter: brightness(1) drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            animation: logoEntrance 1s ease-out;
        }

        .logo:hover {
            transform: scale(1.1) rotate(5deg);
            filter: brightness(1.2) drop-shadow(0 5px 15px rgba(0,0,0,0.4));
            animation: pulse 1.5s infinite;
        }

        .logo:active {
            transform: scale(0.95) rotate(-5deg);
            transition: all 0.1s ease;
        }

        /* Анимация пульсации при наведении */
        @keyframes pulse {
            0% {
                transform: scale(1.1) rotate(5deg);
            }
            50% {
                transform: scale(1.15) rotate(5deg);
            }
            100% {
                transform: scale(1.1) rotate(5deg);
            }
        }

        /* Анимация появления логотипа при загрузке */
        @keyframes logoEntrance {
            0% {
                opacity: 0;
                transform: scale(0.5) rotate(-180deg);
            }
            70% {
                transform: scale(1.1) rotate(10deg);
            }
            100% {
                opacity: 1;
                transform: scale(1) rotate(0deg);
            }
        }

        .title-text {
            display: flex;
            flex-direction: column;
        }

        .header-title h1 {
            font-size: 1.8rem;
            margin-bottom: 0.3rem;
        }

        .header-title p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        select, button {
            padding: 0.5rem 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        select:hover, button:hover {
            border-color: #1a2b47;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        button.export { background: #28a745; color: white; border-color: #218838; }
        button.print { background: #17a2b8; color: white; border-color: #138496; }
        button.settings { background: #6c757d; color: white; border-color: #545b62; }

        .container {
            max-width: 1600px;
            margin: 1.5rem auto;
            padding: 0 1.5rem;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1a2b47;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        th, td {
            padding: 0.6rem;
            text-align: center;
            border: 1px solid #e9ecef;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .stats-row {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid #eee;
            font-size: 0.9rem;
            color: #6c757d;
            flex-wrap: wrap;
            gap: 10px;
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        .notifications {
            background: white;
            border-radius: 8px;
            padding: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .notification-item {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem 0;
            border-bottom: 1px solid #eee;
        }

        .notification-item:last-child {
            border-bottom: none;
        }

        .menu-button {
            background-color: #1a2b47;
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .menu-button:hover {
            background-color: #2c4061;
            transform: translateY(-1px);
        }

         .menu-dropdown {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 220px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            border-radius: 6px;
            z-index: 1000;
            margin-top: 0.5rem;
            border: 1px solid #ddd;
        }

        .menu-dropdown.show {
            display: block;
        }

        .menu-item {
            padding: 0.75rem 1.2rem;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 0.7rem;
            font-size: 0.95rem;
        }

        .menu-item:hover {
            background-color: #f8f9fa;
        }
        .menu-item.active {
            background-color: #e3f2fd;
            color: #1a2b47;
            font-weight: bold;
        }
     /* Стили для страницы учета */
        .accounting-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-normal { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-danger { background-color: #dc3545; }
        .status-info { background-color: #17a2b8; }

        .card-with-chart {
            display: flex;
            gap: 1.5rem;
        }

        .card-with-chart .table-container {
            flex: 0 0 40%;
        }

        .card-with-chart .chart-container {
            flex: 0 0 60%;
            height: 250px;
        }

        .tire-size-table tr, .truck-model-table tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .tire-size-table tr:hover, .truck-model-table tr:hover {
            background-color: #f8f9fa;
        }

        .tire-size-table tr.selected, .truck-model-table tr.selected {
            background-color: #e3f2fd;
            font-weight: bold;
        }

        .model-column {
            width: 35%;
            text-align: left;
            padding-left: 1rem;
        }

        .count-column {
            width: 15%;
        }

        .tire-plan-column {
            width: 15%;
        }

        .tire-fact-column {
            width: 15%;
        }

        .chart-wrapper {
            position: relative;
            height: 250px;
            width: 100%;
        }

        .chart-wrapper canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Обновленные стили для блока ходимости */
        .mileage-telemetry-container {
            display: grid;
            grid-template-columns: 1.7fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .mileage-card {
            grid-column: 1;
        }

        .telemetry-notifications-card {
            grid-column: 2;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .telemetry-card {
            flex: 1;
        }

        .compact-notifications {
            flex: 1;
        }

        .compact-notifications .notification-item {
            padding: 0.4rem 0;
            font-size: 0.85rem;
        }

        .compact-notifications .card-title {
            font-size: 1.1rem;
            margin-bottom: 0.8rem;
        }

        .period-selectors {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 1rem;
            justify-content: flex-end;
            flex-wrap: wrap;
        }

        .date-time-inputs {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .date-time-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .date-time-input label {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .date-time-input input {
            padding: 0.4rem 0.6rem;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .apply-period-btn {
            padding: 0.4rem 0.8rem;
            background-color: #1a2b47;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            margin-top: 20px;
            transition: background-color 0.2s;
        }

        .apply-period-btn:hover {
            background-color: #2c4061;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        /* Кастомные высоты графиков */
        .mileage-card .chart-container {
            height: 340px;
        }

        .telemetry-card .chart-container {
            height: 200px;
        }

        @media (max-width: 1200px) {
            .card-with-chart {
                flex-direction: column;
            }
           
            .card-with-chart .table-container {
                flex: 1;
            }
           
            .dashboard {
                grid-template-columns: 1fr;
            }

            .mileage-telemetry-container {
                grid-template-columns: 1fr;
            }

            .mileage-card {
                grid-column: 1;
            }

            .telemetry-notifications-card {
                grid-column: 1;
            }
        }

        @media (max-width: 900px) {
            .controls {
                width: 100%;
                justify-content: flex-start;
            }
            
            .header-title {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .logo-title-container {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="header-title">
            <div class="logo-title-container">
                <!-- Анимированный логотип ПАЗЛ -->
                <img src="пазл.png" alt="Логотип ПАЗЛ" class="logo" onclick="window.location.href='slide2.html'">
                <div class="title-text">
                    <h1>ПАЗЛ</h1>
                    <p>Программный Аналитический модуль Зондирования и Логистического управления СКГШ</p>
                    <p>УК УГОЛЬНЫЙ РАЗРЕЗ</p>
                </div>
            </div>
        </div>

        <div class="controls">
            <select id="regionSelect">
                <option>Регион: Все</option>
                <option>Регион 1</option>
                <option>Регион 2</option>
            </select>
            <select id="enterpriseSelect">
                <option>Предприятие: Все</option>
                <option>Разрез 1</option>
                <option>Разрез 2</option>
                <option>Разрез 3</option>
            </select>
            <button class="export">Экспорт</button>
            <button class="print">Печать</button>
            <button class="settings">Настройки</button>
        </div>
    </div>

    <div class="container">
        <button class="menu-button" id="menuButton">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M2.5 12a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5zm0-4a.5.5 0 0 1 .5-.5h10a.5.5 0 0 1 0 1H3a.5.5 0 0 1-.5-.5z"/>
            </svg>
            Меню системы
        </button>

        <div class="menu-dropdown" id="menuDropdown">
            <div class="menu-item active" onclick="window.location.href='slide3.html'">Главный экран</div>
            <div class="menu-item" onclick="window.location.href='accounting.html'">Блок учета</div>
            <div class="menu-item" onclick="navigateTo('monitoring')">Мониторинг</div>
            <div class="menu-item" onclick="navigateTo('engineer')">Блок шинного инженера</div>
            <div class="menu-item" onclick="navigateTo('analytics')">Аналитика</div>
            <div class="menu-item" onclick="navigateTo('forecast')">Прогноз потребности</div>
            <div class="menu-item" onclick="navigateTo('constructor')">Конструктор отчетов</div>
            <div class="menu-item" onclick="navigateTo('quality')">Качество дорог</div>
            <div class="menu-item" onclick="navigateTo('documents')">Документы и литература</div>
        </div>

        <div class="dashboard">
            <div class="card">
                <h3 class="card-title">Состояние парка</h3>
                <div class="card-with-chart">
                    <div class="table-container">
                        <table class="truck-model-table">
                            <thead>
                                <tr>
                                    <th class="model-column">Модель</th>
                                    <th class="count-column">Кол-во</th>
                                    <th class="tire-plan-column">Шин план</th>
                                    <th class="tire-fact-column">Шин факт</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-model="belaz-75131">
                                    <td class="model-column">БелАЗ 75131</td>
                                    <td>21</td>
                                    <td>126</td>
                                    <td>110</td>
                                </tr>
                                <tr data-model="belaz-7513d">
                                    <td class="model-column">БелАЗ 7513D</td>
                                    <td>12</td>
                                    <td>72</td>
                                    <td>62</td>
                                </tr>
                                <tr data-model="belaz-75306">
                                    <td class="model-column">БелАЗ 75306</td>
                                    <td>10</td>
                                    <td>60</td>
                                    <td>60</td>
                                </tr>
                                <tr data-model="belaz-7530g">
                                    <td class="model-column">БелАЗ 7530G</td>
                                    <td>25</td>
                                    <td>150</td>
                                    <td>125</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="stats-row">
                            <span>Всего шин: 478</span>
                            <span>Шин в эксплуатации: 357</span>
                            <span>В ремонте: 40</span>
                            <span>В резерве: 60</span>
                            <span>К списанию: 21</span>
                       </div>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="parkStateChart"></canvas>
                        <canvas id="tireDistributionChart" style="display: none;"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 class="card-title" id="tireSizeTitle">В том числе по типоразмерам</h3>
                <div class="card-with-chart">
                    <div class="table-container">
                        <table class="tire-size-table">
                            <thead>
                                <tr><th>Типоразмер</th><th>Кол-во</th></tr>
                            </thead>
                            <tbody>
                                <tr data-size="33.00-51"><td>33.00-51</td><td>10</td></tr>
                                <tr data-size="33.00R51"><td>33.00R51</td><td>162</td></tr>
                                <tr data-size="40.00-57"><td>40.00-57</td><td>20</td></tr>
                                <tr data-size="40.00R57"><td>40.00R57</td><td>100</td></tr>
                                <tr data-size="46/90R57"><td>46/90R57</td><td>65</td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="chart-container">
                        <canvas id="tireStateChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="mileage-telemetry-container">
            <div class="card mileage-card">
                <div class="chart-header">
                    <h3 class="card-title">Ходимость шин (тыс. км)</h3>
                    <div class="period-selectors">
                        <div class="date-time-inputs">
                            <div class="date-time-input">
                                <label for="startDateTime">С:</label>
                                <input type="datetime-local" id="startDateTime">
                            </div>
                            <div class="date-time-input">
                                <label for="endDateTime">По:</label>
                                <input type="datetime-local" id="endDateTime">
                            </div>
                            <button class="apply-period-btn" id="applyPeriodBtn">Применить</button>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="mileageChart"></canvas>
                </div>
            </div>

            <div class="telemetry-notifications-card">
                <div class="card telemetry-card">
                    <h3 class="card-title">Телеметрия (состояние СКДШ)</h3>
                    <div class="chart-container">
                        <canvas id="telemetryChart"></canvas>
                    </div>
                </div>

                <div class="notifications compact-notifications">
                    <h3 class="card-title">Уведомления (за последние 24 часа)</h3>
                    <div class="notification-item">
                        <span><span class="status-indicator status-warning"></span>Отклонение параметров</span>
                        <span>2</span>
                    </div>
                    <div class="notification-item">
                        <span><span class="status-indicator status-danger"></span>Требует внимания</span>
                        <span>16</span>
                    </div>
                    <div class="notification-item">
                        <span><span class="status-indicator status-info"></span>Нарушена позиция</span>
                        <span>15</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('menuButton').addEventListener('click', function() {
            const dropdown = document.getElementById('menuDropdown');
            dropdown.classList.toggle('show');
        });

        document.addEventListener('click', function(event) {
            const menuButton = document.getElementById('menuButton');
            const dropdown = document.getElementById('menuDropdown');
            if (!menuButton.contains(event.target) && !dropdown.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        function navigateTo(section) {
            alert(`Переход к разделу: ${section}`);
            document.getElementById('menuDropdown').classList.remove('show');
        }

        function showSlide(slideId) {
            alert(`Переход к слайду: ${slideId}`);
        }

        const tireSizeData = {
            'sizeDistribution': {
                labels: ['33.00-51', '33.00R51', '40.00-57', '40.00R57', '46/90R57'],
                data: [10, 162, 20, 100, 65],
                backgroundColor: [
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(153, 102, 255, 0.7)',
                    'rgba(255, 159, 64, 0.7)',
                    'rgba(255, 99, 132, 0.7)'
                ]
            },
            '33.00-51': [5, 3, 1, 1, 0],
            '33.00R51': [80, 40, 15, 25, 2],
            '40.00-57': [10, 5, 2, 3, 0],
            '40.00R57': [60, 20, 8, 10, 2],
            '46/90R57': [14, 16, 4, 30, 1]
        };

        let currentChartMode = 'general';
        let selectedModel = null;
        let selectedTireSize = null;
        let parkStateChart, tireDistributionChart, tireStateChart, mileageChart, telemetryChart;

        function setDefaultDateRange() {
            const now = new Date();
            const endDate = new Date(now);
            const startDate = new Date(now);
            startDate.setMonth(startDate.getMonth() - 1);
            
            const formatDateForInput = (date) => {
                return date.toISOString().slice(0, 16);
            };
            
            document.getElementById('startDateTime').value = formatDateForInput(startDate);
            document.getElementById('endDateTime').value = formatDateForInput(endDate);
        }

        document.getElementById('applyPeriodBtn').addEventListener('click', function() {
            const startDateTime = document.getElementById('startDateTime').value;
            const endDateTime = document.getElementById('endDateTime').value;
            
            if (!startDateTime || !endDateTime) {
                alert('Пожалуйста, выберите начальную и конечную дату');
                return;
            }
            
            updateMileageChartByPeriod(startDateTime, endDateTime);
        });

        function updateMileageChartByPeriod(startDate, endDate) {
            console.log('Обновление графика ходимости для периода:', startDate, 'до', endDate);
            
            const newData = [
                [Math.floor(Math.random() * 50) + 100, Math.floor(Math.random() * 70) + 130, Math.floor(Math.random() * 40) + 90, Math.floor(Math.random() * 60) + 110, Math.floor(Math.random() * 50) + 100],
                [Math.floor(Math.random() * 60) + 120, Math.floor(Math.random() * 80) + 140, Math.floor(Math.random() * 50) + 100, Math.floor(Math.random() * 70) + 130, Math.floor(Math.random() * 60) + 120],
                [Math.floor(Math.random() * 40) + 80, Math.floor(Math.random() * 60) + 100, Math.floor(Math.random() * 30) + 70, Math.floor(Math.random() * 50) + 90, Math.floor(Math.random() * 40) + 80]
            ];
            
            mileageChart.data.datasets[0].data = newData[0];
            mileageChart.data.datasets[1].data = newData[1];
            mileageChart.data.datasets[2].data = newData[2];
            mileageChart.update();
            
            const startFormatted = new Date(startDate).toLocaleDateString('ru-RU');
            const endFormatted = new Date(endDate).toLocaleDateString('ru-RU');
            document.querySelector('.mileage-card .card-title').textContent = 
                `Ходимость шин (тыс. км) - период: ${startFormatted} - ${endFormatted}`;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const parkStateCtx = document.getElementById('parkStateChart').getContext('2d');
            parkStateChart = new Chart(parkStateCtx, {
                type: 'bar',
                data: {
                    labels: ['БелАЗ 75131', 'БелАЗ 7513D', 'БелАЗ 75306', 'БелАЗ 7530G'],
                    datasets: [
                        {
                            label: 'Шин факт',
                            data: [110, 62, 60, 125],
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Отсутствуют',
                            data: [16, 10, 0, 25],
                            backgroundColor: 'rgba(255, 159, 64, 0.7)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true,
                            title: {
                                display: true,
                                text: 'Модели'
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Количество шин'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Состояние парка',
                            font: {
                                size: 14
                            }
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const models = ['БелАЗ 75131', 'БелАЗ 7513D', 'БелАЗ 75306', 'БелАЗ 7530G'];
                                    const plans = [126, 72, 60, 150];
                                    const index = context.dataIndex;
                                   
                                    if (context.dataset.label === 'Шин факт') {
                                        return `План: ${plans[index]}`;
                                    } else {
                                        return `Факт: ${plans[index] - context.parsed.y}`;
                                    }
                                }
                            }
                        }
                    }
                }
            });

            const tireDistributionCtx = document.getElementById('tireDistributionChart').getContext('2d');
            tireDistributionChart = new Chart(tireDistributionCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Передняя ось',
                            data: [],
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Правая задняя',
                            data: [],
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Левая задняя',
                            data: [],
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Типоразмеры'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Количество шин'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Распределение шин по осям',
                            font: {
                                size: 14
                            }
                        }
                    }
                }
            });

            const tireStateCtx = document.getElementById('tireStateChart').getContext('2d');
            tireStateChart = new Chart(tireStateCtx, {
                type: 'doughnut',
                data: {
                    labels: tireSizeData.sizeDistribution.labels,
                    datasets: [{
                        data: tireSizeData.sizeDistribution.data,
                        backgroundColor: tireSizeData.sizeDistribution.backgroundColor,
                        borderColor: [
                            'rgba(54, 162, 235, 1)',
                            'rgba(75, 192, 192, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)',
                            'rgba(255, 99, 132, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                        },
                        title: {
                            display: true,
                            text: 'Распределение шин по типоразмерам'
                        }
                    }
                }
            });

            const mileageCtx = document.getElementById('mileageChart').getContext('2d');
            mileageChart = new Chart(mileageCtx, {
                type: 'bar',
                data: {
                    labels: ['33.00-51', '33.00R51', '40.00-57', '40.00R57', '46/90R57'],
                    datasets: [
                        {
                            label: 'Bridgestone',
                            data: [125, 142, 118, 138, 132],
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Michelin',
                            data: [148, 176, 142, 162, 156],
                            backgroundColor: 'rgba(75, 192, 192, 0.7)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'Goodyear',
                            data: [112, 130, 106, 126, 120],
                            backgroundColor: 'rgba(153, 102, 255, 0.7)',
                            borderColor: 'rgba(153, 102, 255, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 200,
                            title: {
                                display: true,
                                text: 'Тысячи километров'
                            }
                        }
                    }
                }
            });

            // ОБНОВЛЕННЫЙ ГРАФИК ТЕЛЕМЕТРИИ
            const telemetryCtx = document.getElementById('telemetryChart').getContext('2d');
            telemetryChart = new Chart(telemetryCtx, {
                type: 'bar',
                data: {
                    labels: ['Сэнсор', 'EVA', 'KODA', 'Pre.Pro.'],
                    datasets: [
                        {
                            label: 'Работают',
                            data: [25, 5, 11, 9],
                            backgroundColor: 'rgba(40, 167, 69, 0.7)',
                            borderColor: 'rgba(40, 167, 69, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Нет связи',
                            data: [5, 5, 4, 1],
                            backgroundColor: 'rgba(255, 159, 64, 0.7)',
                            borderColor: 'rgba(255, 159, 64, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'КТГ (%)',
                            data: [83, 50, 73, 90],
                            type: 'line',
                            borderColor: 'rgba(0, 0, 0, 0)', // Прозрачная синяя линия
                            backgroundColor: 'rgba(0, 0, 255, 0.1)',
                            pointBackgroundColor: 'blue', // Синие точки
                            pointBorderColor: 'blue',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            fill: false,
                            tension: 0.1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Количество систем'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            max: 100,
                            title: {
                                display: true,
                                text: 'КТГ (%)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    }
                }
            });

            // Добавляем метки данных для КТГ
            Chart.register({
                id: 'ktgLabels',
                afterDatasetsDraw(chart, args, options) {
                    const { ctx, data, scales: { x, y1 } } = chart;
                    
                    // Находим индекс набора данных для КТГ
                    const ktgDatasetIndex = chart.data.datasets.findIndex(dataset => dataset.label === 'КТГ (%)');
                    if (ktgDatasetIndex === -1) return;

                    const meta = chart.getDatasetMeta(ktgDatasetIndex);
                    ctx.save();
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'bottom';
                    ctx.fillStyle = 'blue';

                    meta.data.forEach((point, index) => {
                        const value = data.datasets[ktgDatasetIndex].data[index];
                        const { x: xPos, y: yPos } = point;
                        ctx.fillText(`${value}%`, xPos, yPos - 10); // Немного выше точки
                    });

                    ctx.restore();
                }
            });

            // Обработчик выбора типоразмера
            document.querySelectorAll('.tire-size-table tbody tr').forEach(row => {
                row.addEventListener('click', function() {
                    const clickedSize = this.getAttribute('data-size');
                    
                    if (selectedTireSize === clickedSize) {
                        document.querySelectorAll('.tire-size-table tbody tr').forEach(r => {
                            r.classList.remove('selected');
                        });
                        
                        tireStateChart.data.labels = tireSizeData.sizeDistribution.labels;
                        tireStateChart.data.datasets[0].data = tireSizeData.sizeDistribution.data;
                        tireStateChart.data.datasets[0].backgroundColor = tireSizeData.sizeDistribution.backgroundColor;
                        tireStateChart.options.plugins.title.text = 'Распределение шин по типоразмерам';
                        selectedTireSize = null;
                    } else {
                        document.querySelectorAll('.tire-size-table tbody tr').forEach(r => {
                            r.classList.remove('selected');
                        });
                        
                        this.classList.add('selected');
                        
                        selectedTireSize = clickedSize;
                        const count = this.cells[1].textContent;
                        
                        tireStateChart.data.labels = ['Норма', 'Требует ротации', 'Требует ремонта', 'Требует осмотра', 'Наруш. Поз.'];
                        tireStateChart.data.datasets[0].data = tireSizeData[clickedSize];
                        tireStateChart.data.datasets[0].backgroundColor = [
                            'rgba(40, 167, 69, 0.7)',
                            'rgba(255, 193, 7, 0.7)',
                            'rgba(220, 53, 69, 0.7)',
                            'rgba(23, 162, 184, 0.7)',
                            'rgba(108, 117, 125, 0.7)'
                        ];
                        tireStateChart.options.plugins.title.text = `Состояние ${clickedSize} - ${count} шт.`;
                    }
                    
                    tireStateChart.update();
                });
            });

            // Обработчик выбора модели самосвала
            document.querySelectorAll('.truck-model-table tbody tr').forEach(row => {
                row.addEventListener('click', function() {
                    if (currentChartMode === 'detail' && selectedModel === this.getAttribute('data-model')) {
                        showGeneralChart();
                        document.querySelectorAll('.truck-model-table tbody tr').forEach(r => {
                            r.classList.remove('selected');
                        });
                        currentChartMode = 'general';
                        selectedModel = null;
                        return;
                    }
                   
                    document.querySelectorAll('.truck-model-table tbody tr').forEach(r => {
                        r.classList.remove('selected');
                    });
                   
                    this.classList.add('selected');
                   
                    selectedModel = this.getAttribute('data-model');
                    
                    updateTireDistributionChart(selectedModel);
                    currentChartMode = 'detail';
                });
            });

            function updateTireDistributionChart(model) {
                const tireSizes = [];
                const tireCounts = [];
               
                document.querySelectorAll('.tire-size-table tbody tr').forEach(row => {
                    const size = row.getAttribute('data-size');
                    const count = parseInt(row.cells[1].textContent);
                   
                    if ((model === 'belaz-75131' || model === 'belaz-7513d') &&
                        (size === '33.00-51' || size === '33.00R51')) {
                        tireSizes.push(size);
                        tireCounts.push(count);
                    } else if ((model === 'belaz-75306' || model === 'belaz-7530g') &&
                               (size === '40.00-57' || size === '40.00R57' || size === '46/90R57')) {
                        tireSizes.push(size);
                        tireCounts.push(count);
                    }
                });
               
                const totalTiresForModel = parseInt(document.querySelector(`.truck-model-table tr[data-model="${model}"] td:nth-child(4)`).textContent);
               
                const totalTiresInSizes = tireCounts.reduce((sum, val) => sum + val, 0);
               
                const frontAxis = [];
                const rightRear = [];
                const leftRear = [];
               
                tireCounts.forEach((count, index) => {
                    const proportion = count / totalTiresInSizes;
                   
                    const tiresForModel = Math.round(totalTiresForModel * proportion);
                   
                    const basePerAxis = Math.floor(tiresForModel / 6);
                    const remainder = tiresForModel % 6;
                   
                    const frontAdd = Math.min(remainder, Math.floor(Math.random() * 3));
                    const rightAdd = Math.min(remainder - frontAdd, Math.floor(Math.random() * 3));
                    const leftAdd = remainder - frontAdd - rightAdd;
                   
                    frontAxis.push(basePerAxis * 2 + frontAdd);
                    rightRear.push(basePerAxis * 2 + rightAdd);
                    leftRear.push(basePerAxis * 2 + leftAdd);
                });
               
                tireDistributionChart.data.labels = tireSizes;
                tireDistributionChart.data.datasets[0].data = frontAxis;
                tireDistributionChart.data.datasets[1].data = rightRear;
                tireDistributionChart.data.datasets[2].data = leftRear;
               
                tireDistributionChart.options.plugins.title.text = `Распределение шин по осям - ${getModelName(model)}`;
               
                tireDistributionChart.update();
               
                document.getElementById('parkStateChart').style.display = 'none';
                document.getElementById('tireDistributionChart').style.display = 'block';
            }

            function showGeneralChart() {
                document.getElementById('parkStateChart').style.display = 'block';
                document.getElementById('tireDistributionChart').style.display = 'none';
            }

            function getModelName(modelKey) {
                const modelNames = {
                    'belaz-75131': 'БелАЗ 75131',
                    'belaz-7513d': 'БелАЗ 7513D',
                    'belaz-75306': 'БелАЗ 75306',
                    'belaz-7530g': 'БелАЗ 7530G'
                };
                return modelNames[modelKey];
            }
            
            setDefaultDateRange();
        });
    </script>
</body>
</html>
